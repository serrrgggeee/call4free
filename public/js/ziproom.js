const INFO="info";const WARNING="warning";const ERROR="error";const SDP="sdp";const ICE="ice";const google_sighnin_id="130656375808-ocv5rp7tuthr19s8d6vva9j2pp2m8dm8.apps.googleusercontent.com";const data={user_load:false,top_right:false,users_room:[],track_enabled_video:false,track_enabled_audio:false,peerConnections:{},audio_tab:false,left_tabs:false,bottom_menu:false,tracks_callback:null,remot_track_added:null,sender:[],dataChannels:[],imageData:"",audio_stream:null,delay:{out:null},disconnected:true};const method={};function addMethods(method,functions){try{Object.assign(method,functions)}catch(ex){console.log(ex);addMethods(method,functions)}}function insertAfter(referenceNode,newNode){referenceNode.parentNode.insertBefore(newNode,referenceNode.nextSibling)}function htmlToElements(html){var template=document.createElement("template");template.innerHTML=html;return template.content.childNodes}let functions={getDate:today=>{return`${today.getDate()}`.padStart(2,"0")+"."+`${today.getMonth()+1}`.padStart(2,"0")+"."+today.getFullYear()},getDateTime:()=>{return(new Date).toLocaleString()},formatAMPM(date){let hours=date.getHours();let minutes=date.getMinutes();let ampm=hours>=12?"pm":"am";hours=hours%12;hours=hours?hours:12;minutes=minutes<10?"0"+minutes:minutes;const strTime=hours+":"+minutes+" "+ampm;return strTime}};addMethods(method,functions);let init_functions={showOpenButton(){document.getElementById("open_room").style.display="block"},includeHTML(){const el=document.getElementById("room");const file=el.getAttribute("room");if(file){const xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(this.readyState==4){if(this.status==200){el.innerHTML=this.responseText;method.join();getMedia();init_functions.setMainVideo();method.openChat()}if(this.status==404){el.innerHTML="Page not found."}el.removeAttribute("room")}};xhttp.open("GET",file,true);xhttp.send();return}},initGoogleUser(){const signin=document.getElementById("google-signin-client_id");signin.setAttribute("content",google_sighnin_id)},setMainVideo(){main_video=document.getElementById("mainVideo");main_video["srcObject"]=new MediaStream},ready(){init_functions.initGoogleUser()}};addMethods(method,init_functions);var socket=io.connect(window.location.origin);function logger(type,message,value,logging=false){if(logging){socket.emit("logging",type,message,value)}}let video_user_functions={setUserInfo(){if(userInfo){userInfo["img"]=userInfo.getImageUrl();userInfo["ID"]=userInfo.getId();userInfo["name"]=userInfo.getName();userInfo["email"]=userInfo.getEmail();method.showOpenButton();this.setUserParams()}}};addMethods(method,video_user_functions);let userInfo={};function onSignIn(googleUser){userInfo=googleUser.getBasicProfile();logger(INFO,"sign in",userInfo);method.setUserInfo()}let user_functions={setUserParams(){document.getElementById("userImg")["src"]=userInfo.img;document.getElementById("userName").innerHTML=userInfo.name}};addMethods(method,user_functions);function debounce(fn,delay,timeoutID){return function(){clearTimeout(timeoutID.out);let args=arguments;let that=this;timeoutID.out=setTimeout(()=>{fn.apply(that,args)},delay)}}document.addEventListener("click",e=>{const target=e.target;const str=target.getAttribute("m-click");try{let res=str.split("(");const m=res[0];let args=[];if(res[1]){args=res[1].split(")")[0].split(",")}method[m](e,args)}catch(e){}});document.addEventListener("change",e=>{const target=e.target;const m=target.getAttribute("m-change");try{method[m](e)}catch(e){}});document.addEventListener("keyup",e=>{if(e.keyCode===13){e.preventDefault();const target=e.target;const m=target.getAttribute("m-keyup");if(m){try{method[m](e)}catch(e){}}}});function shareImage(e){const target=e.target;const imageList=document.getElementById("image-list");for(let i=0;i<target.files.length;i++){const file=target.files[i];const url=window.URL.createObjectURL(file);const img=createImage(url);imageList.appendChild(img)}}function createImage(url){let img=document.createElement("img");img.src=url;img.classList.add("add_canvas");img.addEventListener("click",e=>{addCanvasPart(e)});return img}function createCanvasFromUrl(url){let img=new Image;img.src=url;img.onload=()=>{if(img.width>data.canvas.width){let ratio=img.width/data.canvas.width;img.width=data.canvas.width;img.height=img.height/ratio;if(img.height>data.canvas.height){let ratio=img.height/data.canvas.height;img.height=data.canvas.height;img.width=img.width/ratio}}if(img.height>data.canvas.height){let ratio=img.height/data.canvas.height;img.height=data.canvas.height;img.width=img.width/ratio;if(img.width>data.canvas.width){let ratio=img.width/data.canvas.width;img.width=data.canvas.width;img.height=img.height/ratio}}data.ctx.clearRect(0,0,data.canvas.width,data.canvas.height);data.ctx.drawImage(img,0,0,img.width,img.height);data.ctx.clearRect(0,0,data.canvas.width,data.canvas.height);data.ctx.drawImage(img,0,0,data.canvas.width,data.canvas.height)}}function changeImage(){socket.emit("show_share","img")}function handleReceiveMessage(event){if(event.data=="\n"){setUserCanvas()}else{data.imageData+=event.data}}function setUserCanvas(){let img=new Image;img.src=data.imageData;img.onload=()=>{data.ctx.drawImage(img,0,0,data.canvas.width,data.canvas.height)};data.imageData=""}function getSharedImage(){for(let dataChannel in data.dataChannels){data.dataChannels[dataChannel].ondatachannel=receiveChannelCallback}socket.emit("share_img","shareImgTracks","RemoteImgTrackAdded")}function onShareImg(id,peerConnection){peerConnection.createOffer().then(sdp=>peerConnection.setLocalDescription(sdp)).then(()=>{socket.emit("offer",id,peerConnection.localDescription,data.tracks_callback,data.remot_track_added)}).catch(function(e){console.log(e)});for(let dataChannel in data.dataChannels){data.dataChannels[dataChannel].ondatachannel=receiveChannelCallback}}function shareImgTracks(peerConnection,id){}function RemoteImgTrackAdded(streams,id){}class Video extends HTMLElement{connectedCallback(){const self=this;this.innerHTML=`<div class="111-111">
      <video class="remoteVideo" id="remoteVideo-${this.item}" playsinline autoplay muted></video>
      <img id="imgsrc-${this.item}" src="imgsrc"></img>
      <!--span id="audio_share" class="get_share" id="getAudioShare">listen</span-->
      <span  id="getImgShare-${this.item}" class="img_share get_share">watch</span>
      <!--audio class="remoteAudio" id="remoteAudio-${this.item}" controls autoplay></audio-->
    </div>`;this.video=document.getElementById("remoteVideo-"+this.item);this.audio=new Audio;this.audio.addEventListener("loadeddata",value=>{this.audio.play()});this.video["srcObject"]=new MediaStream;this.video.style.display="none";this.audio["srcObject"]=new MediaStream;this.room=data.users_room[this.item];this.img=document.getElementById("imgsrc-"+this.item);this.img["src"]=this.room.img;this.video.addEventListener("video",e=>{this.setVideoStream(e["detail"].video)});this.video.addEventListener("audio",e=>{this.setAudionStream(e["detail"].audio)});this.video.addEventListener("click",e=>{console.log(e);main_video["srcObject"]=this.video["srcObject"];main_video.dataset.email=this.room.email})}static get observedAttributes(){return["item"]}get item(){return this.getAttribute("item")}hideVideo(){this.video["srcObject"]=new MediaStream;this.video.style.display="none";this.img["src"]=this.room.img;this.img.style.display="inherit"}setVideoStream(track){track.addEventListener("mute",e=>{this.hideVideo();if(main_video.dataset.email==this.room.email){main_video["srcObject"]=new MediaStream}});try{const img_share=document.getElementById("getImgShare-"+this.item);const tracks=this.video["srcObject"].getTracks();for(var i=0;i<tracks.length;i++){this.video["srcObject"].removeTrack(tracks[i])}if(track.kind){this.video["srcObject"].addTrack(track);this.video.style.display="inherit";this.img.style.display="none"}else{this.hideVideo()}}catch(e){}}setAudionStream(track){try{const tracks=this.audio["srcObject"]["getTracks"]();for(var i=0;i<tracks.length;i++){this.audio["srcObject"]["removeTrack"](tracks[i])}if(track.kind){this.audio["srcObject"]["addTrack"](track)}else{this.audio["srcObject"]=new MediaStream}}catch(e){}}set item(val){if(val){this.setAttribute("item","")}else{this.removeAttribute("item")}}getAudioShare(){getSharedAudio()}getImgShare(){getSharedImage()}}customElements.define("remote-video",Video);(function(){const localVideo=document.querySelector(".localVideo");localVideo.addEventListener("mouseover",video_over);localVideo.addEventListener("click",video_move);function video_over(){localVideo.classList.add("video_over")}function video_move(){localVideo.classList.remove("video_over")}})();function makeResizers(el){let move=false;let resizer_wrapper=document.createElement("div");resizer_wrapper.classList.add("resizer_wrapper");let resizers=document.createElement("div");resizers.classList.add("resizers");let resizable=document.createElement("div");resizable.classList.add("resizable");let top_left=document.createElement("span");top_left.classList.add("resizer","top-left");top_right=document.createElement("span");top_right.classList.add("resizer","top-right");let bottom_left=document.createElement("span");bottom_left.classList.add("resizer","bottom-left");let bottom_right=document.createElement("span");let el_wrapper=document.createElement("div");el_wrapper.classList.add("el_wrapper");resizers.appendChild(top_left);resizers.appendChild(top_right);resizers.appendChild(bottom_left);resizers.appendChild(bottom_right);resizer_wrapper.appendChild(resizers);resizer_wrapper.appendChild(el_wrapper);el_wrapper.appendChild(el);resizer_wrapper.style.width=300+"px";resizer_wrapper.style.height=300+"px";resizable.appendChild(resizer_wrapper);document.body.appendChild(resizable);makeResizableDiv(resizers,el_wrapper,resizers);dragElement(resizable);resizable.addEventListener("mousedown",function(e){const posClear=getMousePos(canvas,e);croperUp(posClear);move=true});let canvas=document.getElementById("sharedImage");document.addEventListener("mouseup",function(e){const nodename=e.target.nodeName;if(nodename=="SPAN")return;if(move){const mousePos=getMousePos(canvas,e);cropperMoved(el,mousePos);move=false}})}function getMousePos(canvas,evt){const rect=canvas.getBoundingClientRect();const targ=evt.target.getBoundingClientRect();return{left:targ.left-rect.left,right:targ.right-rect.left,top:targ.top-rect.top,bottom:targ.bottom-rect.top}}function makeResizableDiv(element,el_wrapper,element_leave){const resizers=element.querySelectorAll(".resizer");let currentResizer;let ev;let offset;let canvas_left;let canvas_top;let element_left;let element_top;let offsetHeight;for(let i=0;i<resizers.length;i++){resizers[i].addEventListener("mousedown",function(e){currentResizer=e.target;ev=e;offset=element.offsetWidth;offsetHeight=element.offsetHeight;canvas_left=el_wrapper.getBoundingClientRect().left;canvas_top=el_wrapper.getBoundingClientRect().top;element_left=element.getBoundingClientRect().left;element_top=element.getBoundingClientRect().top;window.addEventListener("mouseup",stopResize.bind(this));window.addEventListener("mousemove",resize.bind(this))});function resize(e){if(currentResizer&&currentResizer.classList.contains("top-left")){let shift=e.pageX-element_left;let top_shift=e.pageY-element_top;let left=e.pageX-canvas_left;let top=e.pageY-canvas_top;if(left>=0){element.style.left=left+"px";element.style.top=top+"px";let width=Math.abs(offset-shift)+"px";let height=Math.abs(offsetHeight-top_shift)+"px";element.style.width=width;element.style.height=height}}if(currentResizer&&currentResizer.classList.contains("top-right")){let width=e.pageX-el_wrapper.getBoundingClientRect().left;if(width<=el_wrapper.offsetWidth){element.style.width=width+"px"}}if(currentResizer&&currentResizer.classList.contains("bottom-left")){}if(currentResizer&&currentResizer.classList.contains("bottom-right")){}}function stopResize(){window.removeEventListener("mousemove",resize);currentResizer=null}}}function dragElement(elmnt){var pos1=0,pos2=0,pos3=0,pos4=0;if(document.getElementById(elmnt.id+"header")){document.getElementById(elmnt.id+"header").onmousedown=dragMouseDown}else{elmnt.onmousedown=dragMouseDown}function dragMouseDown(e){e=e||window.event;e.preventDefault();pos3=e.clientX;pos4=e.clientY;document.onmouseup=closeDragElement;document.onmousemove=elementDrag}function elementDrag(e){e=e||window.event;e.preventDefault();pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;elmnt.style.top=elmnt.offsetTop-pos2+"px";elmnt.style.left=elmnt.offsetLeft-pos1+"px"}function closeDragElement(){document.onmouseup=null;document.onmousemove=null}}document.addEventListener("DOMContentLoaded",method.ready);const remoteVideos=document.querySelector(".remoteVideos");const localVideo=document.querySelector(".localVideo");let main_video=null;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;const config={iceServers:[{urls:["turn:vokt.ru:8443"],username:"vokt",credential:"vokt"}],RtpDataChannels:true};const constraints={audio:false};const room=!location.pathname.substring(1)?"home":location.pathname.substring(1);function getMedia(callback){if(localVideo["srcObject"]){for(const track of localVideo["srcObject"].getTracks()){track.stop();localVideo["srcObject"].removeTrack(track)}}return navigator.mediaDevices.getUserMedia(constraints).then(stream=>{const video_log=stream.getTracks()[0];logger(INFO,"getMedia",{enabled:video_log.enabled,id:video_log.id,kind:video_log.kind,label:video_log.label,muted:video_log.muted,readyState:video_log.readyState,userInfo:userInfo},true);for(const track of stream.getTracks()){if(!localVideo["srcObject"]){localVideo["srcObject"]=new MediaStream}if(track.kind=="video"){track.enabled=data.track_enabled_video;localVideo["srcObject"].addTrack(track)}if(track.kind=="audio"){track.enabled=data.track_enabled_audio;localVideo["srcObject"].addTrack(track)}}}).catch(getUserMediaError)}function newPeer(id,callback,description){let peerConnection=data.peerConnections[id];if(peerConnection===undefined){peerConnection=new RTCPeerConnection(config);data.peerConnections[id]=peerConnection}peerConnection.onicecandidate=event=>{if(event.candidate&&event.candidate.relatedAddress!==null&&event.candidate.relatedPort!==null){const data={socket_id:id,candidate:event.candidate,description:description};logger(ICE,"candidate",data);socket.emit("candidate",id,event.candidate)}};callback(id,peerConnection,description);peerConnection.ontrack=event=>method[data.remot_track_added](event.streams,id);peerConnection.onremovestream=event=>method.RemoteTrackAdded(event.streams,id);peerConnection.addEventListener("connectionstatechange",event=>{if(peerConnection.connectionState==="connected"){const data={state:peerConnection.connectionState,description:"new peer conected"};logger(ICE,"candidate conected",data)}else{const data={state:peerConnection.connectionState,description:"new peer not conected"};logger(ICE,"candidate conected",data)}})}function onOffer(id,peerConnection,description){method[data.tracks_callback](peerConnection,id);peerConnection.setRemoteDescription(description).then(()=>peerConnection.createAnswer()).then(sdp=>{const data={socket_id:id,description:description,sdp:sdp};logger(SDP,"sdp offer",data);return peerConnection.setLocalDescription(sdp)}).then(function(){socket.emit("answer",id,peerConnection.localDescription)}).catch(function(e){});peerConnection.addEventListener("connectionstatechange",event=>{if(peerConnection.connectionState==="connected"){const data={state:peerConnection.connectionState,description:"offer conected"};logger(ICE,"candidate conected",data)}else{const data={state:peerConnection.connectionState,description:"offer not conected"};logger(ICE,"candidate conected",data)}});try{let dataChannel=peerConnection.createDataChannel("myLabel");data.dataChannels[id]=dataChannel;dataChannel.onopen=handleReceiveChannelStatusChange;dataChannel.onmessage=handleReceiveMessage}catch(ex){}}function onReady(id,peerConnection){method[data.tracks_callback](peerConnection,id);peerConnection.createOffer().then(sdp=>{const data={socket_id:id,sdp:sdp};logger(SDP,"sdp on ready",data);return peerConnection.setLocalDescription(sdp)}).then(()=>{socket.emit("offer",id,peerConnection.localDescription,data.tracks_callback,data.remot_track_added,userInfo)}).catch(function(e){});peerConnection.addEventListener("connectionstatechange",event=>{if(peerConnection.connectionState==="connected"){const data={state:peerConnection.connectionState,description:"ready conected"};logger(ICE,"candidate conected",data)}else{const data={state:peerConnection.connectionState,description:"ready not conected"};logger(ICE,"candidate conected",data)}});try{let dataChannel=peerConnection.createDataChannel("myLabel");data.dataChannels[id]=dataChannel;dataChannel.onopen=handleReceiveChannelStatusChange;dataChannel.onmessage=handleReceiveMessage}catch(e){}}function handleReceiveChannelStatusChange(event){let receiveChannel=event.target;if(receiveChannel){let state=receiveChannel.readyState}}function getUserMediaError(error,stream){logger(INFO,"getUserMediaError",{error:error,userInfo:userInfo},true);data.track_enabled_video=false;try{for(const track of localVideo["srcObject"].getTracks()){track.enabled=data.track_enabled_video}}catch(e){}}function handleRemoteHangup(id){const key=id;data.peerConnections[id]&&data.peerConnections[id].close();delete data.peerConnections[id];delete data.users_room[key]}function removeElement(id){const el=document.getElementById(id);if(el){return el.parentNode.removeChild(el)}}let video_functions={addUser(id,callback,description=null,userInfo){data.users_room[id]=userInfo;newPeer(id,callback,description);this.users_room(id,userInfo["email"])},users_room(id,email){const video=document.querySelectorAll(`[data-email="${email}"]`);if(video.length>0)return;const video_node=document.createElement("div");let remote_videos_str=`<div class="user__item">
        <remote-video data-email="${email}" id="${id}" item=${id} share="item['share']">ffff</remote-video>
      </div>`;video_node.innerHTML=remote_videos_str;document.getElementById("remoteVideos").appendChild(video_node.firstChild)},userTracks(peerConnection,id){if(!localVideo["srcObject"])return;for(var key in data.sender){delete data.sender[key]}for(const track of localVideo["srcObject"].getTracks()){if(track.kind=="audio"&&data.track_enabled_audio||track.kind=="video"&&data.track_enabled_video){try{data.sender[track.id]=peerConnection.addTrack(track,localVideo["srcObject"])}catch(e){}}else{try{peerConnection.removeTrack(data.sender[track.id])}catch(e){}localVideo["srcObject"].removeTrack(track)}}},RemoteTrackAdded(streams,id){if(streams){for(let item in streams){let stream=streams[item];const tracks=stream.getTracks();const email=data.users_room[id]["email"];for(const track in tracks){const event=new CustomEvent(tracks[track].kind,{detail:{[tracks[track].kind]:tracks[track]}});const video=document.querySelector(`[data-email="${email}"] video`);video.dispatchEvent(event)}}}else{data.users_room[id]["video"]={}}},switchOnVideo(){function run(){let display_video="inherit";const switchOnVideo=document.getElementById("switchOnVideo");if(!constraints.video){constraints.video={width:96,height:96};data.track_enabled_video=true;switchOnVideo.classList.add("active")}else{data.track_enabled_video=false;delete constraints.video;switchOnVideo.classList.remove("active");display_video="none"}data.tracks_callback="userTracks";data.remot_track_added="RemoteTrackAdded";getMedia().then(event=>{for(const pc in data.peerConnections){newPeer(pc,onReady,null)}localVideo.style.display=display_video})}debounce(run,1e3,data.delay)()},switchOnAudio(){const switchOnAudio=document.getElementById("switchOnAudio");data.track_enabled_audio=constraints.audio=!constraints.audio;data.tracks_callback="userTracks";data.remot_track_added="RemoteTrackAdded";if(data.track_enabled_audio){switchOnAudio.classList.add("active")}else{constraints.audio=false;switchOnAudio.classList.remove("active")}getMedia().then(event=>{for(const pc in data.peerConnections){newPeer(pc,onReady)}})},isUserLoad(ms){return new Promise((resolve,reject)=>{setTimeout(()=>{if(data.user_load){resolve("result")}else{resolve(this.isUserLoad(ms))}},ms)})},loadEvent(){var script=document.createElement("script");script.onload=function(){};script.src="/js/confing.js";document.head.appendChild(script)},join(ms=1e3){setTimeout(()=>{if(data.disconnected){video_functions.join(1e3)}else{socket.emit("join",socket.id,room,userInfo);socket.emit("ready",userInfo,"userTracks","RemoteTrackAdded");data.user_load=true}},ms)},disconnect(){data.disconnected=true;video_functions.join()},connect(){data.disconnected=false},close_client(id){logger(INFO,"close_client",{id:socket.id});if(socket.id==id){socket.emit("setclosesocketid",id)}},getLesson(e,id){socket.emit("getLesson",id)},closesocketid_set(){socket.close();var win=window.open("about:blank","_self");win.close();window.close()},openChat(ms=1e3){setTimeout(()=>{if(data.disconnected){video_functions.openChat()}else{socket.emit("openChat")}},ms)}};addMethods(method,video_functions);socket.on("full",function(room){alert("Room "+room+" is full")});socket.on("bye",function(id){handleRemoteHangup(id);removeElement(id)});socket.on("ready",(id,tracks_callback,remot_track_added,userInfo)=>{data.tracks_callback=tracks_callback;data.remot_track_added=remot_track_added;method.addUser(id,onReady,null,userInfo)});socket.on("offer",(id,description,tracks_callback,remot_track_added,userInfo)=>{data.tracks_callback=tracks_callback;data.remot_track_added=remot_track_added;method.addUser(id,onOffer,description,userInfo)});socket.on("candidate",function(id,candidate){data.peerConnections[id].addIceCandidate(new RTCIceCandidate(candidate)).catch(e=>{})});socket.on("answer",function(id,description){data.peerConnections[id].setRemoteDescription(description)});socket.on("disconnect",function(){method.disconnect()});socket.on("connect",function(){userInfo["socketId"]=socket.id;method.connect()});socket.on("closeclient",function(id){method.close_client(id)});socket.on("closesocketidset",()=>{method.closesocketid_set()});socket.on("update_lessons",payload=>{console.log(payload)});Object.assign(data,{isChatInit:[]});let chat_functions={sendChatMessage:e=>{const chatMessage=document.getElementById("chatMessage");const editId=chatMessage.dataset.editId;delete chatMessage.dataset.editId;const today=new Date;let date_time=method.getDateTime();if(chatMessage["value"].length>1){socket.emit("sendChat",{userInfo:userInfo,message:chatMessage["value"],date_time:date_time,editId:editId})}chatMessage["value"]=""},editChatMessage:(e,args)=>{const id=args[0];const message=document.getElementById("message_"+id);const chatMessage=document.getElementById("chatMessage");chatMessage.dataset.editId=id;const today=new Date;if(message.textContent.length>1){chatMessage["value"]=message.textContent}},addChat:item=>{const today=new Date;const date=method.getDate(today);const created=new Date(item.created);if(date==method.getDate(created)){item.datetime=method.formatAMPM(created)}else{item.datetime=`${method.getDate(created)} ${method.formatAMPM(created)}`}const res=`<div class="item">
        <div class="user"><img src="${item.user_info.img}" class="paa" alt="${item.user_info.name}" 
            title="${item.user_info.name}">
          <div class="date-time">${item.datetime}</div>
          <div class="edit-message" m-click="editChatMessage(${item.id})">edit</div>
        </div>
        <div id="message_${item.id}" class="message">${item.message}</div>
      </div>`;return res},updateChat:item=>{const chatWraper=document.getElementById(`message_${item.id}`).innerHTML=item.message},hideChat:()=>{const chatWraper=document.getElementById("chat-wrapper");chatWraper.style.display=chatWraper.style.display=="none"?"flex":"none";method.checkReadMessage()},checkReadMessage(){let retrievedObject=localStorage.getItem("chatCount");let retrieved_chat=JSON.parse(retrievedObject);if(retrieved_chat==null){retrieved_chat={}}let all_message=document.querySelectorAll(`#initChatMessages .item img:not([title*="${userInfo["name"]}"])`).length;retrieved_chat[room]=all_message;localStorage.setItem("chatCount",JSON.stringify(retrieved_chat));this.changeDisplayCountMessages(all_message,all_message)},checkUnReadMessage(){let retrievedObject=localStorage.getItem("chatCount");let retrieved_chat=JSON.parse(retrievedObject);if(retrieved_chat){let count_read_messages=retrieved_chat[room];let all_message=document.querySelectorAll(`#initChatMessages .item img:not([title*="${userInfo["name"]}"])`).length;if(all_message>count_read_messages){this.changeDisplayCountMessages(all_message,count_read_messages)}}localStorage.setItem("chatCount",JSON.stringify(retrieved_chat))},changeDisplayCountMessages(all_message,count_read_messages){const chat=document.getElementById("chat");let count_unread_message=all_message-count_read_messages;const chat_node=document.createElement("div");let count_read_messages_str=`<span id="countUnreadMessages">${count_unread_message}</span>`;if(count_unread_message>0){chat_node.innerHTML=count_read_messages_str;document.getElementById("chat_button").appendChild(chat_node.firstChild)}else{document.getElementById("countUnreadMessages").remove()}}};addMethods(method,chat_functions);socket.on("responseChat",(payload,id)=>{const chat_node=document.createElement("div");chat_node.innerHTML=method.addChat(payload);const item=document.getElementById("initChatMessages");item.insertBefore(chat_node.firstChild,item.firstChild);const chatWraper=document.getElementById("chat-wrapper");if(chatWraper.style.display=="flex"){method.checkReadMessage()}else{method.checkUnReadMessage()}if(id){method.updateChat(payload);return}});socket.on("initChatMessages",payload=>{if(!data.isChatInit.includes(room)){data.isChatInit.push(room)}const chat_node=document.createElement("div");method.isUserLoad(1e3).then(()=>{payload.reverse();payload.forEach(item=>{chat_node.innerHTML=method.addChat(item);document.getElementById("initChatMessages").appendChild(chat_node.firstChild)});method.checkUnReadMessage()})});Object.assign(data,{});let lesson_functions={addLesson:lesson=>{const res=`
        <h2 class="header">${lesson.title}</h2>
        <div class="articles">${lesson_functions.articles(lesson.articles)}</div>
    `;const lesson_node=document.createElement("div");lesson_node.innerHTML=res;lesson_node.classList.add("item");const lessons=document.getElementById("lessons-wrapper");lessons.innerHTML="";lessons.append(lesson_node);return res},articles(lesson_articles){let articles="";for(const i in lesson_articles){const title=lesson_articles[i].title;const text=lesson_articles[i].text;articles+=`
        <h3 class="header">${title}</h3>
        <div class="text">${text}</div>
      `}return articles}};addMethods(method,lesson_functions);socket.on("send_lesson",lesson=>{method.addLesson(lesson)});